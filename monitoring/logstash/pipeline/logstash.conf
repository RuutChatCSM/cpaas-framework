input {
  # Docker logs
  beats {
    port => 5044
  }

  # Syslog input for Kamailio and FreeSWITCH
  syslog {
    port => 5514
    type => "syslog"
  }

  # File inputs for various log files
  file {
    path => "/var/log/nginx/*.log"
    type => "nginx"
    start_position => "beginning"
  }

  file {
    path => "/var/log/kamailio/*.log"
    type => "kamailio"
    start_position => "beginning"
  }

  file {
    path => "/var/log/freeswitch/*.log"
    type => "freeswitch"
    start_position => "beginning"
  }
}

filter {
  # Parse NGINX logs
  if [type] == "nginx" {
    grok {
      match => { 
        "message" => "%{NGINXACCESS}" 
      }
    }
    
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
    
    mutate {
      convert => { "response" => "integer" }
      convert => { "bytes" => "integer" }
      convert => { "responsetime" => "float" }
    }
  }

  # Parse Kamailio logs
  if [type] == "kamailio" {
    grok {
      match => { 
        "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:host} %{WORD:program}: %{GREEDYDATA:message}" 
      }
      overwrite => [ "message" ]
    }
    
    date {
      match => [ "timestamp", "MMM dd HH:mm:ss" ]
    }
  }

  # Parse FreeSWITCH logs
  if [type] == "freeswitch" {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{WORD:level}\] %{GREEDYDATA:message}" 
      }
      overwrite => [ "message" ]
    }
    
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
    }
  }

  # Parse Somleng application logs
  if [type] == "somleng" {
    if [message] =~ /^\{/ {
      json {
        source => "message"
      }
    } else {
      grok {
        match => { 
          "message" => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:level} -- : %{GREEDYDATA:message}" 
        }
        overwrite => [ "message" ]
      }
    }
    
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
    }
  }

  # Add common fields
  mutate {
    add_field => { "environment" => "production" }
    add_field => { "service" => "somleng-cpaas" }
  }

  # Remove unwanted fields
  mutate {
    remove_field => [ "beat", "input", "agent", "ecs", "host" ]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "logstash-%{+YYYY.MM.dd}"
    template_name => "logstash"
    template_pattern => "logstash-*"
    template => {
      "index_patterns" => ["logstash-*"]
      "settings" => {
        "number_of_shards" => 1
        "number_of_replicas" => 0
      }
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" }
          "message" => { "type" => "text" }
          "level" => { "type" => "keyword" }
          "type" => { "type" => "keyword" }
          "service" => { "type" => "keyword" }
          "environment" => { "type" => "keyword" }
        }
      }
    }
  }

  # Debug output (remove in production)
  # stdout { codec => rubydebug }
}