# Complete Somleng Infrastructure - Production Ready
# Based on official Somleng and SomlengSWITCH architecture
# https://github.com/somleng/somleng-switch

version: '3.8'

services:
  # =============================================================================
  # INFRASTRUCTURE SERVICES
  # =============================================================================
  
  db:
    image: postgres:15-alpine
    container_name: somleng_postgres
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-somleng}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-somleng}"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: public.ecr.aws/docker/library/redis:alpine
    container_name: somleng_redis
    restart: ${RESTART_POLICY:-unless-stopped}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # SOMLENG CORE (CPaaS Platform)
  # =============================================================================

  somleng_web:
    image: ghcr.io/somleng/somleng:latest
    container_name: somleng_web
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      RAILS_ENV: ${RAILS_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-somleng}
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      SWITCH_HOST: somleng_switch_app:8080
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3000:3000"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  somleng_sidekiq:
    image: ghcr.io/somleng/somleng:latest
    container_name: somleng_sidekiq
    restart: ${RESTART_POLICY:-unless-stopped}
    command: bundle exec sidekiq -c ${SIDEKIQ_CONCURRENCY:-10}
    env_file:
      - .env
    environment:
      RAILS_ENV: ${RAILS_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-somleng}
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - somleng_network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # =============================================================================
  # SOMLENGSWITCH - OPENSIPS GATEWAYS
  # =============================================================================

  # Bootstrap databases for OpenSIPS gateways
  gateway_bootstrap:
    build:
      context: /tmp/somleng-switch/components/gateway
      target: bootstrap
    container_name: somleng_gateway_bootstrap
    restart: "no"
    environment:
      DATABASE_USERNAME: ${POSTGRES_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_NAME: opensips_public_gateway
    depends_on:
      db:
        condition: service_healthy
    networks:
      - somleng_network
    command: ["create_db"]

  # Public Gateway for Carrier Connections (IP Authentication)
  public_gateway:
    build:
      context: /tmp/somleng-switch/components/gateway
      target: public_gateway
    container_name: somleng_public_gateway
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:5432/opensips_public_gateway
      FIFO_NAME: /opensips/fifo/public_gateway
      PUBLIC_IP: ${PUBLIC_IP}
    depends_on:
      gateway_bootstrap:
        condition: service_completed_successfully
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "5080:5080/udp"
    volumes:
      - opensips_fifo:/opensips/fifo
    networks:
      somleng_network:
        ipv4_address: 172.20.0.10
    healthcheck:
      test: ["CMD-SHELL", "nc -z -w 5 $$(hostname -i) 5060"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Client Gateway for Customer Connections (SIP Registration)
  client_gateway:
    build:
      context: /tmp/somleng-switch/components/gateway
      target: client_gateway
    container_name: somleng_client_gateway
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:5432/opensips_client_gateway
      FIFO_NAME: /opensips/fifo/client_gateway
      PUBLIC_IP: ${PUBLIC_IP}
    depends_on:
      gateway_bootstrap:
        condition: service_completed_successfully
      media_proxy:
        condition: service_healthy
    ports:
      - "5070:5060/udp"
      - "5070:5060/tcp"
    volumes:
      - opensips_fifo:/opensips/fifo
    networks:
      somleng_network:
        ipv4_address: 172.20.0.11
    healthcheck:
      test: ["CMD-SHELL", "nc -z -w 5 $$(hostname -i) 5060"]
      interval: 30s
      timeout: 10s
      retries: 5

  # =============================================================================
  # SOMLENGSWITCH - MEDIA PROXY
  # =============================================================================

  media_proxy:
    build:
      context: /tmp/somleng-switch/components/media_proxy
    container_name: somleng_media_proxy
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      PUBLIC_IP: ${PUBLIC_IP}
    ports:
      - "2223:2223/udp"
      - "20000-30000:20000-30000/udp"
    networks:
      somleng_network:
        ipv4_address: 172.20.0.12
    healthcheck:
      test: ["CMD-SHELL", "nc -z -w 5 $$(hostname -i) 2223"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # =============================================================================
  # SOMLENGSWITCH - FREESWITCH CLUSTER
  # =============================================================================

  freeswitch1:
    build:
      context: /tmp/somleng-switch/components/freeswitch
    container_name: somleng_freeswitch1
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      FS_EXT_PROFILE_NAT_INSTANCE_IP: ${PUBLIC_IP}
      FS_EVENT_SOCKET_PASSWORD: ${FS_EVENT_SOCKET_PASSWORD:-secret}
      FS_EVENT_SOCKET_PORT: 8021
      FS_LOG_LEVEL: ${FS_LOG_LEVEL:-info}
      FS_MOD_RAYO_MAX_IDLE_SECS: 5
    ports:
      - "5062:5060/udp"
      - "5062:5060/tcp"
      - "5222:5222/tcp"
      - "8021:8021/tcp"
      - "16384-32767:16384-32767/udp"
    volumes:
      - freeswitch1_logs:/usr/local/freeswitch/log
      - freeswitch1_recordings:/usr/local/freeswitch/recordings
    depends_on:
      public_gateway:
        condition: service_healthy
    networks:
      somleng_network:
        ipv4_address: 172.20.0.20
    healthcheck:
      test: ["CMD-SHELL", "nc -z -w 5 localhost 5222"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  freeswitch2:
    build:
      context: /tmp/somleng-switch/components/freeswitch
    container_name: somleng_freeswitch2
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      FS_EXT_PROFILE_NAT_INSTANCE_IP: ${PUBLIC_IP}
      FS_EVENT_SOCKET_PASSWORD: ${FS_EVENT_SOCKET_PASSWORD:-secret}
      FS_EVENT_SOCKET_PORT: 8021
      FS_LOG_LEVEL: ${FS_LOG_LEVEL:-info}
      FS_MOD_RAYO_MAX_IDLE_SECS: 5
    ports:
      - "5064:5060/udp"
      - "5064:5060/tcp"
      - "5224:5222/tcp"
      - "8022:8021/tcp"
      - "32768-49151:16384-32767/udp"
    volumes:
      - freeswitch2_logs:/usr/local/freeswitch/log
      - freeswitch2_recordings:/usr/local/freeswitch/recordings
    depends_on:
      public_gateway:
        condition: service_healthy
    networks:
      somleng_network:
        ipv4_address: 172.20.0.21
    healthcheck:
      test: ["CMD-SHELL", "nc -z -w 5 localhost 5222"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # =============================================================================
  # SOMLENGSWITCH - TWIML ENGINE
  # =============================================================================

  somleng_switch_app:
    build:
      context: /tmp/somleng-switch/components/app
    container_name: somleng_switch_app
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      AHN_CORE_HOST: freeswitch1
      AHN_CORE_HTTP_PORT: 8080
      CALL_PLATFORM_HOST: http://somleng_web:3000
      REDIS_URL: redis://redis:6379/1
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-us-east-1}
    depends_on:
      redis:
        condition: service_healthy
      freeswitch1:
        condition: service_healthy
      somleng_web:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      somleng_network:
        ipv4_address: 172.20.0.30
    healthcheck:
      test: ["CMD-SHELL", "wget --server-response --spider --quiet http://0.0.0.0:8080/health_checks 2>&1 | grep '200 OK' > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # =============================================================================
  # SOMLENGSWITCH - EVENT LOGGERS
  # =============================================================================

  freeswitch1_event_logger:
    build:
      context: /tmp/somleng-switch/components/freeswitch_event_logger
    container_name: somleng_freeswitch1_event_logger
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      EVENT_SOCKET_HOST: freeswitch1:8021
      EVENT_SOCKET_PASSWORD: ${FS_EVENT_SOCKET_PASSWORD:-secret}
      REDIS_URL: redis://redis:6379/1
    depends_on:
      redis:
        condition: service_healthy
      freeswitch1:
        condition: service_healthy
    networks:
      - somleng_network

  freeswitch2_event_logger:
    build:
      context: /tmp/somleng-switch/components/freeswitch_event_logger
    container_name: somleng_freeswitch2_event_logger
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      EVENT_SOCKET_HOST: freeswitch2:8021
      EVENT_SOCKET_PASSWORD: ${FS_EVENT_SOCKET_PASSWORD:-secret}
      REDIS_URL: redis://redis:6379/1
    depends_on:
      redis:
        condition: service_healthy
      freeswitch2:
        condition: service_healthy
    networks:
      - somleng_network

  # =============================================================================
  # SOMLENGSWITCH - SERVICES (Load Balancer Management)
  # =============================================================================

  somleng_services:
    build:
      context: /tmp/somleng-switch/components/services
    container_name: somleng_services
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      OPENSIPS_PUBLIC_GATEWAY_DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:5432/opensips_public_gateway
      OPENSIPS_CLIENT_GATEWAY_DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:5432/opensips_client_gateway
      PUBLIC_GATEWAY_HOST: public_gateway
      CLIENT_GATEWAY_HOST: client_gateway
      MEDIA_PROXY_HOST: media_proxy
    depends_on:
      db:
        condition: service_healthy
      public_gateway:
        condition: service_healthy
      client_gateway:
        condition: service_healthy
      media_proxy:
        condition: service_healthy
    networks:
      - somleng_network

  # =============================================================================
  # SOMLENGSWITCH - OPENSIPS SCHEDULERS
  # =============================================================================

  public_gateway_scheduler:
    build:
      context: /tmp/somleng-switch/components/opensips_scheduler
    container_name: somleng_public_gateway_scheduler
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      OPENSIPS_FIFO: /opensips/fifo/public_gateway
      OPENSIPS_HOST: public_gateway
    depends_on:
      public_gateway:
        condition: service_healthy
    volumes:
      - opensips_fifo:/opensips/fifo
    networks:
      - somleng_network

  client_gateway_scheduler:
    build:
      context: /tmp/somleng-switch/components/opensips_scheduler
    container_name: somleng_client_gateway_scheduler
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      OPENSIPS_FIFO: /opensips/fifo/client_gateway
      OPENSIPS_HOST: client_gateway
    depends_on:
      client_gateway:
        condition: service_healthy
    volumes:
      - opensips_fifo:/opensips/fifo
    networks:
      - somleng_network

  # =============================================================================
  # REVERSE PROXY
  # =============================================================================

  nginx:
    build:
      context: /tmp/somleng-switch/components/nginx
    container_name: somleng_nginx
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      somleng_web:
        condition: service_healthy
    networks:
      - somleng_network
    volumes:
      - nginx_logs:/var/log/nginx

  # =============================================================================
  # SMS GATEWAY
  # =============================================================================

  sms_gateway:
    image: ghcr.io/somleng/sms-gateway:latest
    container_name: somleng_sms_gateway
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      SOMLENG_API_URL: http://somleng_web:3000
      SMS_GATEWAY_MODE: ${SMS_GATEWAY_MODE:-http}
    depends_on:
      somleng_web:
        condition: service_healthy
    networks:
      - somleng_network

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  opensips_fifo:
    driver: local
  freeswitch1_logs:
    driver: local
  freeswitch1_recordings:
    driver: local
  freeswitch2_logs:
    driver: local
  freeswitch2_recordings:
    driver: local
  nginx_logs:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  somleng_network:
    driver: bridge
    ipam:
      config:
        - subnet: ${DOCKER_SUBNET:-172.20.0.0/16}
          gateway: 172.20.0.1