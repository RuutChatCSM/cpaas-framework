version: "3.9"

services:
  # =============================================================================
  # DATABASE SERVICES
  # =============================================================================
  
  db:
    image: postgres:15-alpine
    container_name: somleng_postgres
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5432:5432"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      postgres
      -c shared_buffers=${POSTGRES_SHARED_BUFFERS:-256MB}
      -c effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      -c work_mem=${POSTGRES_WORK_MEM:-4MB}
      -c maintenance_work_mem=64MB
      -c random_page_cost=1.1
      -c temp_file_limit=2GB
      -c log_min_duration_statement=1000
      -c log_connections=on
      -c log_disconnections=on
      -c log_lock_waits=on

  redis:
    image: redis:7-alpine
    container_name: somleng_redis
    restart: ${RESTART_POLICY:-unless-stopped}
    volumes:
      - redis_data:/data
      - ./monitoring/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "6379:6379"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: redis-server /usr/local/etc/redis/redis.conf
    sysctls:
      - net.core.somaxconn=65535

  # =============================================================================
  # SOMLENG CORE SERVICES
  # =============================================================================

  web:
    image: somleng/somleng:latest
    container_name: somleng_web
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - RAILS_ENV=${RAILS_ENV}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - somleng_uploads:/app/public/uploads
      - somleng_logs:/app/log
    ports:
      - "3000:3000"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  sidekiq:
    image: somleng/somleng:latest
    container_name: somleng_sidekiq
    restart: ${RESTART_POLICY:-unless-stopped}
    command: bundle exec sidekiq -c ${SIDEKIQ_CONCURRENCY:-10}
    env_file:
      - .env
    environment:
      - RAILS_ENV=${RAILS_ENV}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_healthy
    volumes:
      - somleng_uploads:/app/public/uploads
      - somleng_logs:/app/log
    networks:
      - somleng_network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # =============================================================================
  # FREESWITCH MEDIA SERVERS
  # =============================================================================

  freeswitch1:
    image: somleng/somleng-freeswitch:latest
    container_name: somleng_freeswitch1
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - SOMLENG_API_URL=${SOMLENG_API_URL}
      - SOMLENG_API_USERNAME=${SOMLENG_API_USERNAME}
      - SOMLENG_API_PASSWORD=${SOMLENG_API_PASSWORD}
      - EXT_RTP_IP=${EXT_RTP_IP}
      - EXT_SIP_IP=${EXT_SIP_IP}
      - FS_EVENT_SOCKET_PASSWORD=${FS_EVENT_SOCKET_PASSWORD}
    ports:
      - "5062:5060/udp"
      - "5062:5060/tcp"
      - "5063:5061/tcp"
      - "8021:8021"  # Event Socket
      - "${RTP_START_PORT:-16384}-${RTP_END_PORT:-32768}:${RTP_START_PORT:-16384}-${RTP_END_PORT:-32768}/udp"
    volumes:
      - freeswitch1_logs:/usr/local/freeswitch/log
      - freeswitch1_recordings:/usr/local/freeswitch/recordings
    depends_on:
      web:
        condition: service_healthy
      kamailio:
        condition: service_started
    networks:
      somleng_network:
        ipv4_address: 172.20.0.10
    healthcheck:
      test: ["CMD", "fs_cli", "-x", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  freeswitch2:
    image: somleng/somleng-freeswitch:latest
    container_name: somleng_freeswitch2
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - SOMLENG_API_URL=${SOMLENG_API_URL}
      - SOMLENG_API_USERNAME=${SOMLENG_API_USERNAME}
      - SOMLENG_API_PASSWORD=${SOMLENG_API_PASSWORD}
      - EXT_RTP_IP=${EXT_RTP_IP}
      - EXT_SIP_IP=${EXT_SIP_IP}
      - FS_EVENT_SOCKET_PASSWORD=${FS_EVENT_SOCKET_PASSWORD}
    ports:
      - "5064:5060/udp"
      - "5064:5060/tcp"
      - "5065:5061/tcp"
      - "8022:8021"  # Event Socket
      - "32769-49152:${RTP_START_PORT:-16384}-${RTP_END_PORT:-32768}/udp"
    volumes:
      - freeswitch2_logs:/usr/local/freeswitch/log
      - freeswitch2_recordings:/usr/local/freeswitch/recordings
    depends_on:
      web:
        condition: service_healthy
      kamailio:
        condition: service_started
    networks:
      somleng_network:
        ipv4_address: 172.20.0.11
    healthcheck:
      test: ["CMD", "fs_cli", "-x", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # =============================================================================
  # SIP ROUTING AND SBC
  # =============================================================================

  kamailio:
    image: kamailio/kamailio:5.7-alpine
    container_name: somleng_kamailio
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - KAMAILIO_DB_URL=${KAMAILIO_DB_URL}
      - SIP_DOMAIN=${SIP_DOMAIN}
      - SIP_REALM=${SIP_REALM}
      - PUBLIC_IP=${PUBLIC_IP}
    ports:
      - "${KAMAILIO_SIP_PORT:-5060}:5060/udp"
      - "${KAMAILIO_SIP_PORT:-5060}:5060/tcp"
      - "${KAMAILIO_TLS_PORT:-5061}:5061/tcp"
      - "9060:9060"  # MI interface
    volumes:
      - ./kamailio/config:/etc/kamailio:ro
      - kamailio_logs:/var/log/kamailio
      - ./nginx/ssl:/etc/ssl/certs:ro
    depends_on:
      db:
        condition: service_healthy
      rtpengine:
        condition: service_started
    networks:
      somleng_network:
        ipv4_address: 172.20.0.5
    healthcheck:
      test: ["CMD", "kamctl", "monitor", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  rtpengine:
    image: sipwise/rtpengine:latest
    container_name: somleng_rtpengine
    restart: ${RESTART_POLICY:-unless-stopped}
    network_mode: host
    environment:
      - RTPENGINE_LISTEN_IP=${RTPENGINE_LISTEN_IP}
      - RTPENGINE_PUBLIC_IP=${RTPENGINE_PUBLIC_IP}
    command: >
      rtpengine
      --interface=${RTPENGINE_LISTEN_IP}
      --listen-ng=127.0.0.1:2223
      --port-min=${RTPENGINE_PORT_MIN:-20000}
      --port-max=${RTPENGINE_PORT_MAX:-30000}
      --recording-dir=/var/lib/rtpengine
      --recording-method=pcap
      --recording-format=eth
      --log-level=6
      --log-stderr
      --pidfile=/var/run/rtpengine.pid
      --no-fallback
    volumes:
      - rtpengine_recordings:/var/lib/rtpengine
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # =============================================================================
  # SMS GATEWAY
  # =============================================================================

  sms_gateway:
    image: somleng/sms-gateway:latest
    container_name: somleng_sms_gateway
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - SMS_GATEWAY_MODE=${SMS_GATEWAY_MODE}
      - SOMLENG_API_URL=${SOMLENG_API_URL}
      - SMPP_HOST=${SMPP_HOST}
      - SMPP_PORT=${SMPP_PORT}
      - SMPP_USERNAME=${SMPP_USERNAME}
      - SMPP_PASSWORD=${SMPP_PASSWORD}
    depends_on:
      web:
        condition: service_healthy
    volumes:
      - sms_logs:/app/log
    networks:
      - somleng_network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # =============================================================================
  # STUN/TURN SERVER (for WebRTC NAT traversal)
  # =============================================================================

  coturn:
    image: coturn/coturn:4.6.2-alpine
    container_name: somleng_coturn
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "5349:5349/tcp"
      - "49152-65535:49152-65535/udp"
    volumes:
      - ./stun-turn/turnserver.conf:/etc/turnserver.conf:ro
      - ./nginx/ssl:/etc/ssl/certs:ro
    command: ["-c", "/etc/turnserver.conf"]
    networks:
      - somleng_network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # =============================================================================
  # REVERSE PROXY AND LOAD BALANCER
  # =============================================================================

  nginx:
    image: nginx:1.25-alpine
    container_name: somleng_nginx
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl
      - nginx_logs:/var/log/nginx
    depends_on:
      web:
        condition: service_healthy
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # =============================================================================
  # MONITORING STACK
  # =============================================================================

  prometheus:
    image: prom/prometheus:latest
    container_name: somleng_prometheus
    restart: ${RESTART_POLICY:-unless-stopped}
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_TIME:-15d}'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:latest
    container_name: somleng_grafana
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    depends_on:
      - prometheus
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # ELK STACK FOR LOGGING
  # =============================================================================

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: somleng_elasticsearch
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      - discovery.type=single-node
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "curl -u elastic:${ELASTIC_PASSWORD} -f http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    container_name: somleng_kibana
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - kibana_data:/usr/share/kibana/data
    ports:
      - "${KIBANA_PORT:-5601}:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.1
    container_name: somleng_logstash
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - ./monitoring/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./monitoring/logstash/config:/usr/share/logstash/config:ro
      - logstash_data:/usr/share/logstash/data
    ports:
      - "5044:5044"  # Beats input
      - "9600:9600"  # Logstash monitoring
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - somleng_network

  # =============================================================================
  # BACKUP SERVICE
  # =============================================================================

  backup:
    image: alpine:latest
    container_name: somleng_backup
    restart: "no"
    environment:
      - BACKUP_S3_BUCKET=${BACKUP_S3_BUCKET}
      - BACKUP_S3_ACCESS_KEY=${BACKUP_S3_ACCESS_KEY}
      - BACKUP_S3_SECRET_KEY=${BACKUP_S3_SECRET_KEY}
      - BACKUP_S3_REGION=${BACKUP_S3_REGION}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./scripts/backup.sh:/backup.sh:ro
      - postgres_data:/var/lib/postgresql/data:ro
      - backup_data:/backup
    depends_on:
      - db
    networks:
      - somleng_network
    command: /bin/sh -c "apk add --no-cache postgresql-client aws-cli && crond -f"

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  somleng_uploads:
    driver: local
  somleng_logs:
    driver: local
  freeswitch1_logs:
    driver: local
  freeswitch1_recordings:
    driver: local
  freeswitch2_logs:
    driver: local
  freeswitch2_recordings:
    driver: local
  kamailio_logs:
    driver: local
  rtpengine_recordings:
    driver: local
  sms_logs:
    driver: local
  nginx_logs:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  elasticsearch_data:
    driver: local
  kibana_data:
    driver: local
  logstash_data:
    driver: local
  backup_data:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  somleng_network:
    driver: bridge
    ipam:
      config:
        - subnet: ${DOCKER_SUBNET:-172.20.0.0/16}
          gateway: 172.20.0.1