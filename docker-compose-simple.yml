# =============================================================================
# SOMLENG CPAAS PRODUCTION DEPLOYMENT - SIMPLIFIED VERSION
# Based on official Somleng architecture
# =============================================================================

services:
  # =============================================================================
  # DATABASE SERVICES
  # =============================================================================

  db:
    image: postgres:15-alpine
    container_name: somleng_postgres
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: somleng_redis
    restart: ${RESTART_POLICY:-unless-stopped}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # SOMLENG CORE SERVICES
  # =============================================================================

  web:
    image: ghcr.io/somleng/somleng:latest
    container_name: somleng_web
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - RAILS_ENV=${RAILS_ENV}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - CALL_PLATFORM_HOST=http://web:3000
      - SWITCH_HOST=http://somleng-switch:8080
      - ANYCABLE_SECRET=${ANycABLE_SECRET:-secret}
      - ANYCABLE_BROADCAST_ADAPTER=redisx
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      somleng-switch:
        condition: service_healthy
    volumes:
      - somleng_uploads:/app/public/uploads
      - somleng_logs:/app/log
    ports:
      - "3000:3000"
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "wget --server-response --spider --quiet http://0.0.0.0:3000/health_checks 2>&1 | grep '200 OK' > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3

  sidekiq:
    image: ghcr.io/somleng/somleng:latest
    container_name: somleng_sidekiq
    restart: ${RESTART_POLICY:-unless-stopped}
    command: bundle exec sidekiq -c ${SIDEKIQ_CONCURRENCY:-10}
    env_file:
      - .env
    environment:
      - RAILS_ENV=${RAILS_ENV}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - CALL_PLATFORM_HOST=http://web:3000
      - SWITCH_HOST=http://somleng-switch:8080
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_healthy
    volumes:
      - somleng_uploads:/app/public/uploads
      - somleng_logs:/app/log
    networks:
      - somleng_network

  # =============================================================================
  # FREESWITCH MEDIA SERVER
  # =============================================================================

  freeswitch:
    image: ghcr.io/somleng/freeswitch:latest
    container_name: somleng_freeswitch
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - FS_DATABASE_HOST=db
      - FS_MOD_JSON_CDR_URL=http://web:3000/services/call_data_records
      - FS_EXTERNAL_SIP_IP=${EXT_SIP_IP}
      - FS_EXTERNAL_RTP_IP=${EXT_RTP_IP}
      - FS_EVENT_SOCKET_PASSWORD=${FS_EVENT_SOCKET_PASSWORD}
    ports:
      - "5060:5060/udp"
      - "5222:5222/tcp"
      - "5080:5080/udp"
      - "8021:8021/tcp"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "nc -z -w 5 localhost 5222"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - freeswitch_logs:/usr/local/freeswitch/log
      - freeswitch_recordings:/usr/local/freeswitch/recordings

  somleng-switch:
    image: ghcr.io/somleng/switch-app:latest
    container_name: somleng_switch
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - AHN_CORE_HOST=freeswitch
      - AHN_CORE_HTTP_PORT=8080
      - CALL_PLATFORM_HOST=http://web:3000
      - REDIS_URL=${REDIS_URL}
    depends_on:
      redis:
        condition: service_healthy
      freeswitch:
        condition: service_healthy
    networks:
      - somleng_network
    healthcheck:
      test: ["CMD-SHELL", "wget --server-response --spider --quiet http://0.0.0.0:8080/health_checks 2>&1 | grep '200 OK' > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # SMS GATEWAY
  # =============================================================================

  sms_gateway:
    image: ghcr.io/somleng/sms-gateway:latest
    container_name: somleng_sms_gateway
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      - SMS_GATEWAY_MODE=${SMS_GATEWAY_MODE}
      - SOMLENG_API_URL=${SOMLENG_API_URL}
      - DEVICE_TOKEN=${DEVICE_TOKEN:-change-me}
    ports:
      - "3210:3210"
    depends_on:
      web:
        condition: service_healthy
    volumes:
      - sms_logs:/app/log
    networks:
      - somleng_network

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  somleng_uploads:
    driver: local
  somleng_logs:
    driver: local
  freeswitch_logs:
    driver: local
  freeswitch_recordings:
    driver: local
  sms_logs:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  somleng_network:
    driver: bridge
    ipam:
      config:
        - subnet: ${DOCKER_SUBNET:-172.20.0.0/16}
          gateway: 172.20.0.1